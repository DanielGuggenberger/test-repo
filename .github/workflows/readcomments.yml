name: check-comment-test

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  count-comments:
    runs-on: ubuntu-latest

    permissions:
      pull-requests: read
      issues: read

    steps:
      - uses: actions/checkout@v4

      - name: Count PR comments
        if: ${{ github.event_name == 'pull_request' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "Reading comments for PR #$PR_NUMBER"

          # Issue-Kommentare laden (Conversation comments)
          ISSUE_COMMENTS=$(curl -s \
             -H "Authorization: Bearer $GITHUB_TOKEN" \
             https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments)

          ISSUE_COUNT=$(echo "$ISSUE_COMMENTS" | jq length)

          # Review-Kommentare laden (Inline review comments)
          REVIEW_COMMENTS=$(curl -s \
             -H "Authorization: Bearer $GITHUB_TOKEN" \
             https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/comments)

          REVIEW_COUNT=$(echo "$REVIEW_COMMENTS" | jq length)

          TOTAL=$((ISSUE_COUNT + REVIEW_COUNT))

          echo "Issue Kommentare:  $ISSUE_COUNT"
          echo "Review Kommentare: $REVIEW_COUNT"
          echo "--------------------------------"
          echo "Gesamt Anzahl Kommentare: $TOTAL"
